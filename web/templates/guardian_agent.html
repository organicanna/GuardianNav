<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Guardian - Agent Live</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', 'Consolas', 'Monaco', monospace;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .terminal-container {
            max-width: 1000px;
            margin: 2rem auto;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #334155;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .terminal-header {
            background: linear-gradient(90deg, #1e293b 0%, #334155 100%);
            padding: 1rem 2rem;
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid #475569;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .terminal-controls {
            display: flex;
            gap: 0.5rem;
        }

        .control-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .close { background: #ef4444; }
        .minimize { background: #f59e0b; }
        .maximize { background: #10b981; }

        .terminal-body {
            padding: 2rem;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 70vh;
            overflow-y: auto;
        }

        .output-line {
            margin: 0.5rem 0;
            padding: 0.25rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .prompt {
            color: #22d3ee;
            font-weight: bold;
            min-width: 80px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }

        .status-active { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        .status-info { background: #3b82f6; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .voice-controls {
            background: rgba(30, 41, 59, 0.8);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #475569;
        }

        .voice-button {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .voice-button:hover {
            background: linear-gradient(45deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .voice-button:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voice-button.listening {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            animation: recording 1.5s ease-in-out infinite;
        }

        @keyframes recording {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .response-area {
            background: rgba(51, 65, 85, 0.6);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #10b981;
            min-height: 100px;
        }

        .typing-indicator {
            display: none;
            color: #64748b;
        }

        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .back-button {
            position: fixed;
            top: 2rem;
            left: 2rem;
            background: rgba(30, 41, 59, 0.9);
            color: #e2e8f0;
            border: 1px solid #475569;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(51, 65, 85, 0.9);
            transform: translateY(-1px);
        }

        .user-info {
            background: rgba(16, 185, 129, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .scenario-info {
            background: rgba(59, 130, 246, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .emergency-level {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .level-low { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .level-medium { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .level-high { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* Responsive */
        @media (max-width: 768px) {
            .terminal-container {
                margin: 1rem;
                border-radius: 8px;
            }
            
            .terminal-body {
                padding: 1rem;
                font-size: 0.8rem;
            }
            
            .back-button {
                position: static;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <a href="/map" class="back-button">‚Üê Retour √† la carte</a>
    
    <div class="terminal-container">
        <div class="terminal-header">
            <div class="terminal-title">
                <span>üõ°Ô∏è</span>
                <span>Guardian Agent Live - Session Interactive</span>
                <span class="status-indicator status-active"></span>
            </div>
            <div class="terminal-controls">
                <div class="control-dot close"></div>
                <div class="control-dot minimize"></div>
                <div class="control-dot maximize"></div>
            </div>
        </div>
        
        <div class="terminal-body">
            <div id="output">
                <!-- La sortie sera g√©n√©r√©e ici -->
            </div>
            
            <!-- Informations utilisateur -->
            <div class="user-info" id="userInfo">
                <div class="output-line">
                    <div class="prompt">üë§ USER:</div>
                    <div>Chargement des informations utilisateur...</div>
                </div>
            </div>
            
            <!-- Sc√©nario actuel -->
            <div class="scenario-info">
                <div class="output-line">
                    <div class="prompt">üó∫Ô∏è ROUTE:</div>
                    <div>Trajet Paris: Google France ‚Üí Place de la Concorde</div>
                </div>
                <div class="output-line">
                    <div class="prompt">üìç STATUS:</div>
                    <div>Surveillance active - Agent Guardian op√©rationnel</div>
                </div>
            </div>
            
            <!-- Contr√¥les vocaux -->
            <div class="voice-controls">
                <div class="output-line">
                    <div class="prompt">üé§ VOICE:</div>
                    <div>Reconnaissance vocale avanc√©e activ√©e</div>
                </div>
                
                <button id="startListening" class="voice-button">
                    üé§ Parler √† Guardian
                </button>
                
                <button id="stopListening" class="voice-button" disabled>
                    üõë Arr√™ter l'√©coute
                </button>
                
                <button id="testCommand" class="voice-button">
                    üß™ Test vocal
                </button>
                
                <button id="toggleTTS" class="voice-button" style="background: linear-gradient(45deg, #f59e0b, #d97706);">
                    üîä Audio ON
                </button>
            </div>
            
            <!-- Zone de r√©ponse de Guardian -->
            <div class="response-area">
                <div class="output-line">
                    <div class="prompt">ü§ñ GUARDIAN:</div>
                    <div id="guardianResponse">En attente de votre commande vocale...</div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <div class="prompt">ü§ñ GUARDIAN:</div>
                    <div>Guardian analyse votre demande<span class="typing-dots"></span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isListening = false;
        let recognition = null;
        let userConfig = {};
        let conversationHistory = [];
        let speechSynthesis = window.speechSynthesis;
        let currentVoice = null;

        // Initialisation
        window.addEventListener('load', function() {
            initializeSpeechSynthesis();
            initializeGuardianAgent();
            loadUserInfo();
            displayWelcomeMessage();
        });

        function initializeSpeechSynthesis() {
            // Initialiser la synth√®se vocale
            if ('speechSynthesis' in window) {
                // Attendre que les voix soient charg√©es
                function loadVoices() {
                    const voices = speechSynthesis.getVoices();
                    // Chercher une voix fran√ßaise
                    currentVoice = voices.find(voice => 
                        voice.lang.startsWith('fr') && voice.name.toLowerCase().includes('thomas')
                    ) || voices.find(voice => 
                        voice.lang.startsWith('fr')
                    ) || voices[0];
                    
                    if (currentVoice) {
                        addOutput('üîä TTS', `Voix Guardian: ${currentVoice.name} (${currentVoice.lang})`, 'info');
                    }
                }
                
                if (speechSynthesis.getVoices().length > 0) {
                    loadVoices();
                } else {
                    speechSynthesis.onvoiceschanged = loadVoices;
                }
            } else {
                addOutput('‚ùå TTS', 'Synth√®se vocale non support√©e', 'warning');
            }
        }

        function speakText(text, urgency = 'normal') {
            if (!speechSynthesis || !currentVoice) return;
            
            // Nettoyer le texte des emojis et caract√®res sp√©ciaux
            const cleanText = text.replace(/[ü§ñüëÇüß≠üì±üõ°Ô∏èüè•üìçüöëüé§üó£Ô∏è‚ùåüë§üìûüó∫Ô∏èüìäüí™ü§óüßò‚Äç‚ôÄÔ∏è‚ö°ü™ëüíßüå¨Ô∏èüë•üö∂‚Äç‚ôÄÔ∏èüëÄüèÉ‚Äç‚ôÄÔ∏èüëãüìàüö®üîä]/g, '')
                                 .replace(/\s+/g, ' ')
                                 .trim();
            
            if (cleanText.length === 0) return;
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.voice = currentVoice;
            utterance.lang = 'fr-FR';
            
            // Ajuster la vitesse et le ton selon l'urgence
            switch(urgency) {
                case 'urgent':
                    utterance.rate = 1.1;
                    utterance.pitch = 1.1;
                    break;
                case 'calm':
                    utterance.rate = 0.8;
                    utterance.pitch = 0.9;
                    break;
                default:
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
            }
            
            utterance.volume = 0.8;
            
            utterance.onstart = function() {
                addOutput('üîä TTS', 'Lecture vocale en cours...', 'info');
            };
            
            utterance.onend = function() {
                addOutput('üîä TTS', 'Lecture vocale termin√©e', 'info');
            };
            
            utterance.onerror = function(event) {
                addOutput('‚ùå TTS', `Erreur lecture vocale: ${event.error}`, 'warning');
            };
            
            // Arr√™ter toute lecture en cours et d√©marrer la nouvelle
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        function initializeGuardianAgent() {
            addOutput('üöÄ SYSTEM', 'Initialisation de Guardian Agent Live...', 'info');
            addOutput('üîß SYSTEM', 'Chargement des modules de reconnaissance vocale...', 'info');
            addOutput('üì° SYSTEM', 'Connexion √† l\'API Guardian √©tablie', 'active');
            addOutput('‚úÖ SYSTEM', 'Agent Guardian op√©rationnel - Pr√™t √† recevoir vos commandes', 'active');
        }

        function loadUserInfo() {
            // R√©cup√©rer les informations utilisateur depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            userConfig = {
                firstName: urlParams.get('firstName') || 'Utilisateur',
                lastName: urlParams.get('lastName') || '',
                phone: urlParams.get('phone') || ''
            };

            document.getElementById('userInfo').innerHTML = `
                <div class="output-line">
                    <div class="prompt">üë§ USER:</div>
                    <div>${userConfig.firstName} ${userConfig.lastName}</div>
                </div>
                <div class="output-line">
                    <div class="prompt">üìû PHONE:</div>
                    <div>${userConfig.phone} | <a href="#" onclick="openWhatsApp('${userConfig.phone}')" title="Contacter via WhatsApp" style="color: #25d366; text-decoration: none;">üí¨ WhatsApp</a></div>
                </div>
            `;

            addOutput('üë§ CONFIG', `Utilisateur configur√©: ${userConfig.firstName} ${userConfig.lastName}`, 'info');
        }

        function displayWelcomeMessage() {
            setTimeout(() => {
                const welcomeMsg = `Bonjour ${userConfig.firstName} ! Je suis votre agent Guardian personnel. Je peux vous aider √† analyser votre situation, vous donner des conseils de s√©curit√© et vous assister en cas de besoin. Utilisez la reconnaissance vocale pour me parler naturellement.`;
                
                typeMessage('ü§ñ GUARDIAN', welcomeMsg, 'guardianResponse');
                
                // Lire le message de bienvenue √† voix haute
                setTimeout(() => {
                    speakText(welcomeMsg);
                }, 3000);
            }, 2000);
        }

        function addOutput(prompt, message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = 'output-line';
            
            const statusClass = type === 'active' ? 'status-active' : 
                              type === 'warning' ? 'status-warning' : 
                              type === 'error' ? 'status-error' : 'status-info';
            
            line.innerHTML = `
                <div class="prompt">
                    <span class="status-indicator ${statusClass}"></span>${prompt}:
                </div>
                <div>${message}</div>
            `;
            
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function typeMessage(prompt, message, elementId) {
            const element = document.getElementById(elementId);
            const typingIndicator = document.getElementById('typingIndicator');
            
            // Afficher l'indicateur de frappe
            typingIndicator.style.display = 'block';
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                // Effet de frappe
                element.innerHTML = '';
                let i = 0;
                
                function type() {
                    if (i < message.length) {
                        element.innerHTML += message.charAt(i);
                        i++;
                        setTimeout(type, 30);
                    }
                }
                
                type();
            }, 1500);
        }

        // Gestion de la reconnaissance vocale
        document.getElementById('startListening').addEventListener('click', startVoiceRecognition);
        document.getElementById('stopListening').addEventListener('click', stopVoiceRecognition);
        document.getElementById('testCommand').addEventListener('click', testVoiceCommand);
        document.getElementById('toggleTTS').addEventListener('click', toggleTextToSpeech);

        function startVoiceRecognition() {
            try {
                if ('webkitSpeechRecognition' in window) {
                    recognition = new webkitSpeechRecognition();
                } else if ('SpeechRecognition' in window) {
                    recognition = new SpeechRecognition();
                } else {
                    addOutput('‚ùå ERROR', 'Reconnaissance vocale non support√©e - Utilisation du mode test', 'warning');
                    testVoiceCommand();
                    return;
                }
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'fr-FR';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceButtons();
                    addOutput('üé§ VOICE', '√âcoute activ√©e - Parlez maintenant !', 'active');
                    document.getElementById('guardianResponse').innerHTML = 'Je vous √©coute... Parlez-moi de votre situation.';
                };
                
                recognition.onresult = function(event) {
                    if (event.results && event.results.length > 0) {
                        const transcript = event.results[0][0].transcript;
                        addOutput('üó£Ô∏è VOUS', `"${transcript}"`, 'info');
                        processVoiceCommand(transcript);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Erreur reconnaissance vocale:', event.error);
                    addOutput('‚ö†Ô∏è WARNING', `Probl√®me vocal - ${event.error}. Essayez le mode test.`, 'warning');
                    isListening = false;
                    updateVoiceButtons();
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateVoiceButtons();
                    addOutput('üé§ VOICE', '√âcoute termin√©e', 'info');
                };
                
                recognition.start();
                addOutput('üé§ SYSTEM', 'D√©marrage de la reconnaissance vocale...', 'info');
                
            } catch (error) {
                console.error('Erreur lors du d√©marrage:', error);
                addOutput('‚ùå ERROR', 'Erreur technique - Utilisation du mode test', 'error');
                testVoiceCommand();
            }
        }

        function stopVoiceRecognition() {
            if (recognition) {
                recognition.stop();
            }
            isListening = false;
            updateVoiceButtons();
        }

        function updateVoiceButtons() {
            const startBtn = document.getElementById('startListening');
            const stopBtn = document.getElementById('stopListening');
            
            if (isListening) {
                startBtn.disabled = true;
                startBtn.classList.add('listening');
                startBtn.innerHTML = 'üé§ En √©coute...';
                stopBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                startBtn.classList.remove('listening');
                startBtn.innerHTML = 'üé§ Parler √† Guardian';
                stopBtn.disabled = true;
            }
        }

        function testVoiceCommand() {
            const testCommands = [
                "Bonjour Guardian, tout va bien pour l'instant",
                "Guardian, je me sens un peu fatigu√© sur ce trajet", 
                "Guardian, il y a beaucoup de monde ici, que dois-je faire ?",
                "Guardian, je ne me sens pas tr√®s bien",
                "Guardian, j'ai l'impression de m'√™tre √©gar√©",
                "Guardian, je ressens des douleurs dans le dos",
                "Guardian, je suis un peu stress√© par la situation"
            ];
            
            const randomCommand = testCommands[Math.floor(Math.random() * testCommands.length)];
            
            addOutput('üß™ TEST', `Commande simul√©e: "${randomCommand}"`, 'warning');
            addOutput('üó£Ô∏è VOUS', `"${randomCommand}"`, 'info');
            
            // Simuler un d√©lai d'analyse
            document.getElementById('guardianResponse').innerHTML = 'Analyse en cours...';
            
            setTimeout(() => {
                processVoiceCommand(randomCommand);
            }, 1500);
        }

        function processVoiceCommand(transcript) {
            // Ajouter √† l'historique
            conversationHistory.push({
                type: 'user',
                message: transcript,
                timestamp: new Date()
            });

            // Analyser avec l'API Guardian
            fetch('/api/guardian/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    situation: transcript,
                    location: 'Trajet Paris - Google France vers Place de la Concorde',
                    user_info: userConfig,
                    conversation_history: conversationHistory
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('R√©ponse Guardian re√ßue:', data);
                if (data.success) {
                    // Afficher la r√©ponse de Guardian
                    let responseMessage = '';
                    
                    // Niveau d'urgence
                    const urgencyLevel = data.urgency_level || 3;
                    let levelClass = urgencyLevel >= 7 ? 'level-high' : urgencyLevel >= 5 ? 'level-medium' : 'level-low';
                    let levelText = urgencyLevel >= 7 ? '√âLEV√â' : urgencyLevel >= 5 ? 'MOD√âR√â' : 'NORMAL';
                    
                    addOutput('üìä ANALYSIS', `Niveau d'urgence: ${urgencyLevel}/10 <span class="emergency-level ${levelClass}">${levelText}</span>`, 'info');
                    
                    // Conseils de Guardian
                    if (data.advice && data.advice.length > 0) {
                        responseMessage = data.advice.join(' ');
                    } else {
                        responseMessage = "J'ai bien re√ßu votre message. Je continue de surveiller votre situation.";
                    }
                    
                    // Afficher la r√©ponse avec effet de frappe
                    typeMessage('ü§ñ GUARDIAN', responseMessage, 'guardianResponse');
                    
                    // Lire la r√©ponse √† voix haute avec urgence adapt√©e
                    setTimeout(() => {
                        const urgencyMode = urgencyLevel >= 7 ? 'urgent' : urgencyLevel >= 5 ? 'normal' : 'calm';
                        speakText(responseMessage, urgencyMode);
                    }, 2000);
                    
                    // Ajouter √† l'historique
                    conversationHistory.push({
                        type: 'guardian',
                        message: responseMessage,
                        urgency_level: urgencyLevel,
                        timestamp: new Date()
                    });
                    
                } else {
                    addOutput('‚ùå ERROR', 'Erreur lors de l\'analyse Guardian', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur Guardian:', error);
                addOutput('‚ùå ERREUR', `Probl√®me connexion: ${error.message}`, 'error');
                
                // R√©ponse de secours personnalis√©e
                const userName = userConfig.firstName || 'mon ami';
                const fallbackResponse = `${userName}, j'ai un probl√®me technique temporaire. En cas d'urgence, composez le 15 (SAMU) ou le 112. Je vais essayer de me reconnecter.`;
                typeMessage('ü§ñ GUARDIAN', fallbackResponse, 'guardianResponse');
                
                // Lire la r√©ponse de secours
                setTimeout(() => {
                    speakText(fallbackResponse, 'urgent');
                }, 1500);
            });
        }

        function toggleTextToSpeech() {
            const ttsBtn = document.getElementById('toggleTTS');
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                ttsBtn.innerHTML = 'üîá Audio OFF';
                ttsBtn.style.background = 'linear-gradient(45deg, #64748b, #475569)';
                addOutput('üîä TTS', 'Synth√®se vocale d√©sactiv√©e', 'warning');
            } else {
                ttsBtn.innerHTML = 'üîä Audio ON';
                ttsBtn.style.background = 'linear-gradient(45deg, #f59e0b, #d97706)';
                addOutput('üîä TTS', 'Synth√®se vocale activ√©e', 'info');
                
                // Test de la synth√®se vocale
                speakText("Synth√®se vocale Guardian r√©activ√©e");
            }
        }

        function openWhatsApp(phone) {
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            let whatsappPhone = cleanPhone;
            
            // Convertir au format international si n√©cessaire
            if (cleanPhone.startsWith('0')) {
                whatsappPhone = '33' + cleanPhone.substring(1);
            } else if (cleanPhone.startsWith('+33')) {
                whatsappPhone = cleanPhone.substring(1);
            } else if (cleanPhone.startsWith('33')) {
                whatsappPhone = cleanPhone;
            }
            
            const whatsappMessage = encodeURIComponent(`Bonjour ! Je souhaite vous contacter via Guardian.`);
            const whatsappUrl = `https://wa.me/${whatsappPhone}?text=${whatsappMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }
    </script>
</body>
</html>