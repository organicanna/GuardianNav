<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Guardian - Suivi de Trajet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Product Sans', 'Roboto', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 1.5rem;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .user-badge {
            background: #202124;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 16px;
            font-size: 0.9rem;
        }

        .status-badge {
            background: #27ae60;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .map-container {
            background: white;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        .route-info {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 1.5rem;
            margin-top: 1rem;
            border-radius: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .info-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .emergency-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .emergency-btn:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .guardian-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .guardian-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .guardian-toggle.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 4px 25px rgba(39, 174, 96, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        }

        .route-steps {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 1.5rem;
            margin-top: 1rem;
            border-radius: 15px;
        }

        .route-steps h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .step-list {
            list-style: none;
        }

        .step-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-right: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            #map {
                height: 400px;
            }
            
            .controls {
                justify-content: stretch;
            }
            
            .control-btn {
                flex: 1;
                justify-content: center;
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 500px;
            flex-direction: column;
            gap: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 0 0 15px 15px;
        }

        .spinner {
            border: 3px solid #e3f2fd;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s linear infinite;
            box-shadow: 0 2px 10px rgba(66, 133, 244, 0.2);
        }

        .loading-text {
            color: #5f6368;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4285f4, #34a853);
            border-radius: 2px;
            animation: progressAnim 3s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes progressAnim {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Bouton Guardian flottant -->
    <div class="guardian-toggle" id="guardianToggle" onclick="toggleGuardian()">
        G
    </div>

    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="/" class="back-btn">‚Üê Retour</a>
                <div>
                    <h1>üó∫Ô∏è Guardian - Suivi de Trajet</h1>
                    <p>Paris - Itin√©raire s√©curis√© en temps r√©el</p>
                </div>
            </div>
            <div class="user-info" id="userInfo">
                <div class="user-badge">üë§ Utilisateur</div>
                <div class="status-badge">üü¢ Suivi actif</div>
            </div>
        </div>

        <div class="map-container">
            <div id="map" class="loading">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                <div class="spinner"></div>
                <div class="loading-text">Chargement de la carte OpenStreetMap...</div>
                <div class="loading-progress">
                    <div class="loading-progress-bar"></div>
                </div>
                <div style="font-size: 0.9rem; color: #9aa0a6; margin-top: 1rem;">
                    ‚ö° Optimis√© pour une meilleure performance
                </div>
            </div>
        </div>

        <div class="route-info">
            <div class="info-card">
                <h3>üìç D√©part</h3>
                <div class="info-value">Google France</div>
                <div>8 rue de Londres, 75009</div>
            </div>
            <div class="info-card">
                <h3>üéØ Destination</h3>
                <div class="info-value">Place Concorde</div>
                <div>75001 Paris</div>
            </div>
            <div class="info-card">
                <h3>‚è±Ô∏è Dur√©e estim√©e</h3>
                <div class="info-value" id="routeDuration">--</div>
            </div>
            <div class="info-card">
                <h3>üìè Distance</h3>
                <div class="info-value" id="routeDistance">--</div>
            </div>
        </div>

        <div class="route-steps">
            <h3>üö∂‚Äç‚ôÄÔ∏è Instructions de navigation</h3>
            <ul class="step-list" id="routeSteps">
                <li class="step-item">
                    <span class="step-number">1</span>
                    Calcul de l'itin√©raire en cours...
                </li>
            </ul>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="centerMap()">
                üéØ Recentrer
            </button>
            <button class="control-btn" onclick="toggleTraffic()">
                üö¶ Trafic
            </button>
            <button class="control-btn" onclick="shareLocation()">
                üì± Partager
            </button>
            <button class="control-btn" id="testGuardianBtn" onclick="testGuardianManually()" style="display: none; background: #34a853;">
                ü§ñ Test Guardian
            </button>
            <button class="control-btn emergency-btn" onclick="reportEmergency()">
                üö® Urgence
            </button>
        </div>
    </div>

    <script>
        let map;
        let routingControl;
        let userConfig = {};
        let guardianActive = false;

        // Points d'int√©r√™t
        const locations = {
            start: {
                lat: 48.8756,
                lng: 2.3264,
                address: "8 rue de Londres, 75009 Paris"
            },
            end: {
                lat: 48.8656,
                lng: 2.3212,
                address: "Place de la Concorde, 75001 Paris"
            }
        };

        function initMap() {
            console.log('üó∫Ô∏è Initialisation de la carte OpenStreetMap avec Leaflet...');
            
            // Mettre √† jour l'indicateur de chargement
            updateLoadingStatus('Initialisation de la carte...');

            try {
                // Initialiser la carte Leaflet avec OpenStreetMap - Options optimis√©es
                map = L.map('map', {
                    center: [48.8706, 2.3238],
                    zoom: 14,
                    zoomControl: true,
                    attributionControl: true,
                    preferCanvas: true, // Am√©liore les performances
                    maxBounds: [[48.8, 2.2], [48.9, 2.4]], // Limiter la zone pour Paris
                    maxBoundsViscosity: 0.8
                });

                // Ajouter les tuiles OpenStreetMap avec serveurs multiples
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18,
                    minZoom: 10,
                    subdomains: ['a', 'b', 'c'], // Serveurs multiples pour la redondance
                    errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjEyOCIgeT0iMTI4IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuMzVlbSI+Q2hhcmdlbWVudC4uLjwvdGV4dD48L3N2Zz4=',
                    crossOrigin: true,
                    // Optimisations de cache et performance
                    updateWhenIdle: false,
                    updateWhenZooming: false,
                    keepBuffer: 2
                });

                // √âv√©nements de chargement des tuiles
                osmLayer.on('loading', function() {
                    updateLoadingStatus('Chargement des tuiles de carte...');
                });

                osmLayer.on('load', function() {
                    updateLoadingStatus('Carte charg√©e! Calcul de l\'itin√©raire...');
                    console.log('‚úÖ Tuiles OpenStreetMap charg√©es');
                    
                    // Calculer l'itin√©raire apr√®s le chargement des tuiles
                    setTimeout(() => {
                        calculateRoute();
                    }, 500);
                });

                osmLayer.on('tileerror', function(e) {
                    console.warn('‚ùå Erreur chargement tuile:', e);
                });

                // Ajouter la couche √† la carte
                osmLayer.addTo(map);

                console.log('‚úÖ Carte OpenStreetMap initialis√©e avec succ√®s');
                
            } catch (error) {
                console.error('‚ùå Erreur initialisation carte:', error);
                updateLoadingStatus('Erreur de chargement de la carte');
                
                // Fallback - afficher un message d'erreur
                document.getElementById('map').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666; background: #f5f5f5;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Carte temporairement indisponible</div>
                        <div style="font-size: 0.9rem;">V√©rifiez votre connexion internet</div>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4285f4; color: white; border: none; border-radius: 5px; cursor: pointer;">R√©essayer</button>
                    </div>
                `;
            }
        }

        function updateLoadingStatus(message) {
            const loadingDiv = document.querySelector('#map .loading');
            if (loadingDiv) {
                loadingDiv.querySelector('div:last-child').textContent = message;
            }
        }

        function calculateRoute() {
            console.log('üìç Calcul de l\'itin√©raire avec OpenStreetMap...');
            updateLoadingStatus('Calcul de l\'itin√©raire optimal...');

            try {
                // Cr√©er le contr√¥leur de routage avec Leaflet Routing Machine - Optimis√©
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(locations.start.lat, locations.start.lng),
                        L.latLng(locations.end.lat, locations.end.lng)
                    ],
                    routeWhileDragging: false,
                    addWaypoints: false,
                    
                    // Options de routage optimis√©es
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'foot', // Optimis√© pour la marche
                        timeout: 10000, // Timeout de 10 secondes
                        polylinePrecision: 5
                    }),
                createMarker: function(i, waypoint, n) {
                    // Cr√©er des marqueurs personnalis√©s
                    let markerIcon, title;
                    if (i === 0) {
                        title = 'D√©part - Google France';
                        markerIcon = L.divIcon({
                            className: 'custom-marker-start',
                            html: '<div style="background: #27ae60; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üè¢</div>',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });
                    } else {
                        title = 'Destination - Place de la Concorde';
                        markerIcon = L.divIcon({
                            className: 'custom-marker-end',
                            html: '<div style="background: #e74c3c; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üéØ</div>',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });
                    }
                    
                    return L.marker(waypoint.latLng, {
                        icon: markerIcon,
                        title: title
                    });
                },
                lineOptions: {
                    styles: [
                        { color: '#667eea', weight: 8, opacity: 0.8 }
                    ]
                },
                show: false, // Masquer le panneau de contr√¥le par d√©faut
                collapsible: false
            }).on('routesfound', function(e) {
                console.log('‚úÖ Itin√©raire OpenStreetMap calcul√©');
                
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // Convertir les distances et temps
                const distanceKm = (summary.totalDistance / 1000).toFixed(1);
                const timeMin = Math.round(summary.totalTime / 60);
                
                // Mettre √† jour les informations d'itin√©raire
                document.getElementById('routeDuration').textContent = `${timeMin} min`;
                document.getElementById('routeDistance').textContent = `${distanceKm} km`;
                
                // Afficher les √©tapes
                displayRouteSteps(routes[0].instructions);
                
            }).on('routingerror', function(e) {
                console.error('‚ùå Erreur calcul itin√©raire OpenStreetMap:', e.error);
                document.getElementById('routeSteps').innerHTML = `
                    <li class="step-item">
                        ‚ùå Impossible de calculer l'itin√©raire avec OpenStreetMap
                    </li>
                `;
                
                // Fallback vers donn√©es statiques
                displayFallbackRoute();
            }).addTo(map);
                
                // Cacher l'indicateur de chargement une fois l'itin√©raire calcul√©
                setTimeout(() => {
                    const mapElement = document.getElementById('map');
                    const loadingElement = mapElement.querySelector('.loading');
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erreur calcul itin√©raire:', error);
                updateLoadingStatus('Erreur de calcul d\'itin√©raire');
                
                // Afficher le fallback
                displayFallbackRoute();
                
                // Cacher le chargement
                setTimeout(() => {
                    const mapElement = document.getElementById('map');
                    const loadingElement = mapElement.querySelector('.loading');
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                }, 1000);
            }
        }

        function displayRouteSteps(instructions) {
            const stepsContainer = document.getElementById('routeSteps');
            stepsContainer.innerHTML = '';

            instructions.slice(0, 8).forEach((instruction, index) => {
                const stepItem = document.createElement('li');
                stepItem.className = 'step-item';
                
                // Nettoyer les instructions
                let text = instruction.text || instruction.instruction || 'Continuer tout droit';
                text = text.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ');
                
                // Formatage de la distance
                let distanceText = '';
                if (instruction.distance) {
                    const distanceM = instruction.distance;
                    distanceText = distanceM < 1000 ? 
                        `${Math.round(distanceM)}m` : 
                        `${(distanceM/1000).toFixed(1)}km`;
                }
                
                stepItem.innerHTML = `
                    <span class="step-number">${index + 1}</span>
                    ${text} 
                    ${distanceText ? `<small style="color: #666;">(${distanceText})</small>` : ''}
                `;
                
                stepsContainer.appendChild(stepItem);
            });

            if (instructions.length > 8) {
                const moreItem = document.createElement('li');
                moreItem.className = 'step-item';
                moreItem.innerHTML = `
                    <span class="step-number">...</span>
                    Et ${instructions.length - 8} autres √©tapes
                `;
                stepsContainer.appendChild(moreItem);
            }
        }

        function displayFallbackRoute() {
            // Donn√©es de fallback si le routage √©choue
            document.getElementById('routeDuration').textContent = '25 min';
            document.getElementById('routeDistance').textContent = '2.1 km';
            
            document.getElementById('routeSteps').innerHTML = `
                <li class="step-item">
                    <span class="step-number">1</span>
                    Sortir de Google France (8 rue de Londres)
                </li>
                <li class="step-item">
                    <span class="step-number">2</span>
                    Prendre la rue de Londres vers le sud
                </li>
                <li class="step-item">
                    <span class="step-number">3</span>
                    Tourner √† droite sur rue Saint-Lazare
                </li>
                <li class="step-item">
                    <span class="step-number">4</span>
                    Continuer sur rue Saint-Lazare jusqu'au boulevard Haussmann
                </li>
                <li class="step-item">
                    <span class="step-number">5</span>
                    Tourner √† gauche sur boulevard Haussmann
                </li>
                <li class="step-item">
                    <span class="step-number">6</span>
                    Continuer jusqu'√† la place de l'Op√©ra
                </li>
                <li class="step-item">
                    <span class="step-number">7</span>
                    Prendre l'avenue de l'Op√©ra vers la place de la Concorde
                </li>
                <li class="step-item">
                    <span class="step-number">8</span>
                    Arriver √† la Place de la Concorde
                </li>
            `;
        }

        function addCustomMarkers() {
            // Marqueur de d√©part
            new google.maps.Marker({
                position: locations.start,
                map: map,
                title: 'D√©part - Google France',
                icon: {
                    url: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#27ae60" stroke="white" stroke-width="3"/>
                            <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">üè¢</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                }
            });

            // Marqueur de destination
            new google.maps.Marker({
                position: locations.end,
                map: map,
                title: 'Destination - Place de la Concorde',
                icon: {
                    url: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#e74c3c" stroke="white" stroke-width="3"/>
                            <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">üéØ</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                }
            });
        }

        function centerMap() {
            if (map) {
                map.setCenter({ lat: 48.8706, lng: 2.3238 });
                map.setZoom(14);
            }
        }

        function toggleTraffic() {
            showTraffic = !showTraffic;
            if (showTraffic) {
                trafficLayer.setMap(map);
                console.log('üö¶ Couche trafic activ√©e');
            } else {
                trafficLayer.setMap(null);
                console.log('üö¶ Couche trafic d√©sactiv√©e');
            }
        }

        function shareLocation() {
            if (navigator.share) {
                navigator.share({
                    title: 'Mon trajet Guardian',
                    text: 'Suivez mon trajet en temps r√©el',
                    url: window.location.href
                });
            } else {
                // Fallback pour copier le lien
                navigator.clipboard.writeText(window.location.href);
                alert('üì± Lien copi√© dans le presse-papiers');
            }
        }

        function reportEmergency() {
            if (confirm('üö® Signaler une urgence ?\n\nCela alertera vos contacts et les services d\'urgence.')) {
                // Redirection vers la page d'urgence avec la position actuelle
                const params = new URLSearchParams(userConfig);
                params.set('emergency', 'true');
                params.set('location', 'Trajet Google France ‚Üí Place Concorde');
                window.location.href = '/emergency?' + params.toString();
            }
        }

        // Variables pour la reconnaissance vocale
        let recognition = null;
        let isListening = false;
        let guardianInterval = null;

        function toggleGuardian() {
            // Rediriger vers la page Guardian agent
            console.log('üõ°Ô∏è Redirection vers Guardian Agent Live');
            showNotification('üõ°Ô∏è Lancement de Guardian Agent Live...', 'info');
            
            // Rediriger vers la page de configuration Guardian apr√®s un court d√©lai pour l'animation
            setTimeout(() => {
                window.location.href = '/guardian/setup';
            }, 500);
        }

        function startGuardianAgent() {
            console.log('üîç D√©marrage de l\'agent Guardian complet...');
            
            // D√©marrer l'API Guardian
            fetch('/api/guardian/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    firstName: userConfig.firstName,
                    lastName: userConfig.lastName,
                    phone: userConfig.phone,
                    location: 'Trajet Paris - Concorde'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('ü§ñ ' + data.message, 'info');
                    
                    // D√©marrer la reconnaissance vocale
                    startVoiceRecognition();
                    
                    // D√©marrer le monitoring intelligent
                    startIntelligentMonitoring();
                }
            })
            .catch(error => {
                console.error('Erreur Guardian:', error);
                showNotification('‚ö†Ô∏è Erreur de connexion - Mode simulation activ√©', 'warning');
                startSimulationMode();
            });
        }

        function startVoiceRecognition() {
            // Demander permission microphone d'abord
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        // Permission accord√©e, arr√™ter le stream
                        stream.getTracks().forEach(track => track.stop());
                        
                        // D√©marrer la reconnaissance vocale
                        initSpeechRecognition();
                    })
                    .catch(function(error) {
                        console.error('Permission micro refus√©e:', error);
                        showNotification('üé§ Permission micro requise - Cliquez sur "Autoriser" puis r√©essayez', 'warning');
                        startSimulationMode();
                    });
            } else if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                // Fallback sans permission explicite
                initSpeechRecognition();
            } else {
                showNotification('üé§ Reconnaissance vocale non support√©e - Mode simulation', 'warning');
                startSimulationMode();
            }
        }

        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'fr-FR';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    console.log('üé§ Reconnaissance vocale active');
                    isListening = true;
                    showNotification('üëÇ Guardian √©coute... Dites "Guardian" puis votre message', 'success');
                    
                    // Changer l'ic√¥ne pour indiquer l'√©coute
                    const guardianBtn = document.getElementById('guardianToggle');
                    guardianBtn.textContent = 'üëÇ';
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                    console.log('üé§ Entendu:', transcript);
                    
                    // D√©tection du mot-cl√© "Guardian" ou "Gardien"
                    if (transcript.includes('guardian') || transcript.includes('gardien') || transcript.includes('garden')) {
                        const guardianBtn = document.getElementById('guardianToggle');
                        guardianBtn.textContent = 'ü§ñ';
                        handleVoiceCommand(transcript);
                        
                        // Revenir √† l'√©coute apr√®s traitement
                        setTimeout(() => {
                            if (guardianActive) {
                                guardianBtn.textContent = 'üëÇ';
                            }
                        }, 3000);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Erreur reconnaissance vocale:', event.error);
                    
                    if (event.error === 'not-allowed') {
                        showNotification('üé§ Permission micro refus√©e - Autorisez le micro dans votre navigateur', 'error');
                    } else if (event.error === 'no-speech') {
                        // Red√©marrer automatiquement
                        if (guardianActive) {
                            setTimeout(() => {
                                recognition.start();
                            }, 1000);
                        }
                    } else {
                        showNotification('üé§ Erreur micro - Mode simulation activ√©', 'warning');
                        startSimulationMode();
                    }
                };
                
                recognition.onend = function() {
                    // Red√©marrer automatiquement si Guardian est toujours actif
                    if (guardianActive && isListening) {
                        setTimeout(() => {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.error('Erreur red√©marrage reconnaissance:', e);
                                startSimulationMode();
                            }
                        }, 1000);
                    }
                };
                
                recognition.start();
                
            } catch (error) {
                console.error('Erreur initialisation reconnaissance vocale:', error);
                showNotification('üé§ Erreur reconnaissance vocale - Mode simulation', 'warning');
                startSimulationMode();
            }
        }

        function handleVoiceCommand(transcript) {
            showNotification('üé§ Message re√ßu: "' + transcript + '"', 'info');
            
            // Analyser avec l'API Guardian
            fetch('/api/guardian/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    situation: transcript,
                    location: 'Trajet Paris - Concorde',
                    user_info: userConfig
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher les conseils de Guardian
                    data.advice.forEach((advice, index) => {
                        setTimeout(() => {
                            showNotification(advice, 'success');
                        }, index * 2000);
                    });
                }
            })
            .catch(error => {
                console.error('Erreur analyse:', error);
                showNotification('ü§ñ Guardian: Je traite votre demande...', 'info');
            });
        }

        function startSimulationMode() {
            // Mode simulation si la reconnaissance vocale ne fonctionne pas
            showNotification('ü§ñ Mode simulation activ√© - Cliquez sur le bouton Guardian pour tester', 'info');
            
            // Changer le bouton pour permettre les tests manuels
            const guardianBtn = document.getElementById('guardianToggle');
            guardianBtn.textContent = 'üí¨';
            guardianBtn.title = 'Mode simulation - Cliquez pour tester Guardian';
            
            // Ajouter un gestionnaire de clic pour les tests manuels
            guardianBtn.onclick = function() {
                if (guardianActive) {
                    // Tester diff√©rents sc√©narios
                    const testScenarios = [
                        'Guardian, tout va bien',
                        'Guardian, je suis un peu fatigu√©',
                        'Guardian, il y a du monde',
                        'Guardian, je ne me sens pas tr√®s bien'
                    ];
                    
                    const randomScenario = testScenarios[Math.floor(Math.random() * testScenarios.length)];
                    showNotification('üé§ Test: "' + randomScenario + '"', 'info');
                    handleVoiceCommand(randomScenario);
                } else {
                    toggleGuardian();
                }
            };
            
            setTimeout(() => {
                if (guardianActive) {
                    showNotification('ü§ñ Guardian: Syst√®me de surveillance actif en mode simulation', 'info');
                }
            }, 3000);
            
            setTimeout(() => {
                if (guardianActive) {
                    showNotification('üìç Position track√©e - Route s√©curis√©e d√©tect√©e', 'success');
                }
            }, 6000);
            
            setTimeout(() => {
                if (guardianActive) {
                    showNotification('üí° Conseil: Utilisez le bouton "Test Guardian" pour tester l\'IA', 'info');
                    // Afficher le bouton de test
                    document.getElementById('testGuardianBtn').style.display = 'inline-flex';
                }
            }, 10000);
        }

        function testGuardianManually() {
            if (!guardianActive) return;
            
            // Sc√©narios de test avec diff√©rents niveaux d'urgence
            const testScenarios = [
                { msg: 'Guardian, tout va bien sur mon trajet', type: 'normal' },
                { msg: 'Guardian, je suis un peu fatigu√©', type: 'attention' },
                { msg: 'Guardian, il y a beaucoup de monde ici', type: 'vigilance' },
                { msg: 'Guardian, je ne me sens pas tr√®s bien', type: 'medical' },
                { msg: 'Guardian, je pense que je me suis √©gar√©', type: 'navigation' },
                { msg: 'Guardian, tout est parfait, merci', type: 'positif' }
            ];
            
            const randomTest = testScenarios[Math.floor(Math.random() * testScenarios.length)];
            
            showNotification('üé§ Test: "' + randomTest.msg + '"', 'info');
            
            // Ajouter un d√©lai pour simuler le traitement
            setTimeout(() => {
                handleVoiceCommand(randomTest.msg);
            }, 1000);
        }

        function startIntelligentMonitoring() {
            console.log('üîç Surveillance intelligente Guardian activ√©e');
            
            // Surveillance continue avec conseils intelligents
            guardianInterval = setInterval(() => {
                if (guardianActive) {
                    const advicePool = [
                        'üö∂ Gardez un rythme r√©gulier',
                        'üëÅÔ∏è Restez attentif √† votre environnement', 
                        'üì± Votre position est s√©curis√©e',
                        'üõ£Ô∏è Trajet optimal maintenu',
                        '‚è∞ Temps estim√© respect√©',
                        'üå°Ô∏è Conditions m√©t√©o favorables',
                        'üö¶ Intersections s√©curis√©es d√©tect√©es'
                    ];
                    
                    const randomAdvice = advicePool[Math.floor(Math.random() * advicePool.length)];
                    showNotification(randomAdvice, 'info');
                }
            }, 15000); // Conseil toutes les 15 secondes
            
            // Message initial
            setTimeout(() => {
                if (guardianActive) {
                    showNotification('ü§ñ IA Guardian: Analyse de votre trajet en cours...', 'info');
                }
            }, 2000);
        }

        function stopGuardianMonitoring() {
            console.log('‚èπÔ∏è Arr√™t de la surveillance Guardian');
            
            // Arr√™ter la reconnaissance vocale
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            
            // Arr√™ter le monitoring
            if (guardianInterval) {
                clearInterval(guardianInterval);
                guardianInterval = null;
            }
            
            isListening = false;
        }

        function showNotification(message, type = 'info') {
            // Cr√©er l'√©l√©ment de notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                max-width: 300px;
                padding: 1rem;
                border-radius: 10px;
                color: white;
                font-weight: 500;
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Couleurs selon le type
            const colors = {
                info: '#3498db',
                success: '#27ae60',
                warning: '#f39c12',
                error: '#e74c3c'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            
            // Ajouter au DOM
            document.body.appendChild(notification);
            
            // Supprimer apr√®s 4 secondes
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Styles d'animation pour les notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Initialisation au chargement
        window.addEventListener('load', function() {
            // R√©cup√©rer les informations utilisateur depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            userConfig = {
                firstName: urlParams.get('firstName') || 'Utilisateur',
                lastName: urlParams.get('lastName') || '',
                phone: urlParams.get('phone') || ''
            };

            // Afficher les informations utilisateur
            document.getElementById('userInfo').innerHTML = `
                <div class="user-badge">üë§ ${userConfig.firstName} ${userConfig.lastName}</div>
                <div class="user-badge">üìû ${userConfig.phone} | <a href="#" onclick="openWhatsApp('${userConfig.phone}')" title="Contacter via WhatsApp" style="color: #25d366; text-decoration: none;">üí¨</a></div>
                <div class="status-badge">üü¢ Suivi actif</div>
            `;

            console.log('üë§ Utilisateur:', userConfig);
        });

        // Gestion des erreurs Google Maps
        window.gm_authFailure = function() {
            console.error('‚ùå Erreur authentification Google Maps');
            document.getElementById('map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                    <div>Carte non disponible</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">Cl√© API Google Maps requise</div>
                </div>
            `;
        };
    </script>

    <!-- Chargement Leaflet pour OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <!-- Plugin Leaflet Routing Machine pour calcul d'itin√©raire -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script>
        function openWhatsApp(phone) {
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            let whatsappPhone = cleanPhone;
            
            // Convertir au format international si n√©cessaire
            if (cleanPhone.startsWith('0')) {
                whatsappPhone = '33' + cleanPhone.substring(1);
            } else if (cleanPhone.startsWith('+33')) {
                whatsappPhone = cleanPhone.substring(1);
            } else if (cleanPhone.startsWith('33')) {
                whatsappPhone = cleanPhone;
            }
            
            const whatsappMessage = encodeURIComponent(`Bonjour ! Je souhaite vous contacter via Guardian.`);
            const whatsappUrl = `https://wa.me/${whatsappPhone}?text=${whatsappMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }
    </script>
</body>
</html>